<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | ArtemScript</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="email-service.js"></script>
    <style>
        /* --- CSS –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º—ã --- */
        :root {
            --bg-body: #1a1a2e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-input: rgba(255, 255, 255, 0.1);
            --text-main: #fff;
            --text-sec: #aaa;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-theme {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --bg-input: #f7f9fc;
            --text-main: #2c3e50;
            --text-sec: #7f8c8d;
            --border-color: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö */
        body { background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; }
        .login-box, .order-card, .modal-box, .chat-box { background: var(--bg-card); box-shadow: var(--shadow); }
        .order-card { border: 1px solid var(--border-color); }
        
        .form-group input, .form-group textarea, .chat-input input, .search-input { 
            background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-color); 
        }
        
        .order-info label { color: var(--text-sec); }
        
        /* --- –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è --- */
        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        .search-wrapper { position: relative; }
        .search-input {
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            width: 250px;
            transition: 0.3s;
        }
        .search-input:focus { width: 300px; border-color: #f39c12; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        
        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            font-size: 18px;
        }
        .btn-icon:hover { background: #f39c12; color: #fff; transform: scale(1.05); }

        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="login" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-login">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>
    
    <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <div class="admin-screen" id="adminScreen">
        <div class="header">
            <h1>üìü –ü–ª–∞–Ω—à–µ—Ç-–∞–¥–º–∏–Ω–∫–∞</h1>
            
            <div class="header-controls">
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ (–Ω–∏–∫, –ø–æ—á—Ç–∞, ID)...">
                </div>
                
                <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
                <button class="btn-icon" onclick="exportData()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫">üíæ</button>
                
                <!-- –°–º–µ–Ω–∞ —Ç–µ–º—ã -->
                <button class="btn-icon" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
                
                <button class="btn-logout" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
            </div>
        </div>
        
        <div class="instruction" id="instruction">
            <button class="instruction-close" onclick="hideInstruction()">‚úï</button>
            <h4>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h4>
            <p>‚Ä¢ <strong>–ù–æ–≤—ã–µ</strong> ‚Äî –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –∑–∞—è–≤–∫–∏<br>
            ‚Ä¢ <strong>–í —Ä–∞–±–æ—Ç–µ</strong> ‚Äî –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏<br>
            ‚Ä¢ <strong>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</strong> ‚Äî –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏<br>
            ‚Ä¢ <strong>–û—Ç–∫–∞–∑</strong> ‚Äî –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –≤–∞–º–∏<br>
            ‚Ä¢ <strong>–û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞</strong> ‚Äî –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
        </div>
        
        <div class="auto-refresh" id="autoRefreshIndicator">
            <div class="online-indicator"></div>
            <span>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (–∫–∞–∂–¥—ã–µ 3 —Å–µ–∫)</span>
        </div>
        
        <div class="folders">
            <div class="folder active" onclick="filterOrders('all', this)">
                <h3 id="count-all">0</h3>
                <span>–í—Å–µ</span>
            </div>
            <div class="folder" onclick="filterOrders('new', this)">
                <h3 id="count-new">0</h3>
                <span>–ù–æ–≤—ã–µ</span>
            </div>
            <div class="folder" onclick="filterOrders('work', this)">
                <h3 id="count-work">0</h3>
                <span>–í —Ä–∞–±–æ—Ç–µ</span>
            </div>
            <div class="folder" onclick="filterOrders('done', this)">
                <h3 id="count-done">0</h3>
                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
            </div>
            <div class="folder" onclick="filterOrders('reject', this)">
                <h3 id="count-reject">0</h3>
                <span>–û—Ç–∫–∞–∑</span>
            </div>
            <div class="folder" onclick="filterOrders('cancel_client', this)">
                <h3 id="count-cancel">0</h3>
                <span>–û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞</span>
            </div>
        </div>
        
        <div class="orders-grid" id="ordersGrid"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è -->
    <div class="reject-modal" id="rejectModal">
        <div class="modal-box">
            <h3>‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</h3>
            <textarea id="rejectReason" placeholder="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..."></textarea>
            <button class="btn-submit" onclick="confirmReject()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–∞–∑</button>
            <button class="btn-cancel-modal" onclick="closeRejectModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-box">
            <div class="chat-header">
                <h3 id="chatTitle">–ß–∞—Ç</h3>
                <button class="chat-close" onclick="closeChatModal()">‚úï</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="typing-indicator" id="typingIndicator">–ö–ª–∏–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendAdminMessage()">üì§</button>
                <label for="adminFileInput" style="background:#27ae60;color:#fff;padding:12px 10px;border-radius:8px;cursor:pointer;">üìé</label>
                <input type="file" id="adminFileInput" style="display:none" onchange="sendAdminFile(this)">
            </div>
        </div>
    </div>
    
    <script>
        const ADMIN_CREDENTIALS = { login: 'admin', password: 'admin123' };
        let currentOrderId = null;
        let currentFilter = 'all';
        let ordersUpdateInterval = null;
        let lastOrdersUpdate = 0;
        let chatUpdateInterval = null;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (localStorage.getItem('adminAuth') === 'true') {
            showAdminPanel();
        }
        
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            
            if (login === ADMIN_CREDENTIALS.login && password === ADMIN_CREDENTIALS.password) {
                localStorage.setItem('adminAuth', 'true');
                localStorage.setItem('adminLoginTime', Date.now().toString());
                showAdminPanel();
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
            } else {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
            }
        });
        
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminScreen').classList.add('active');
            loadOrders();
            startAutoRefresh();
            
            if (!localStorage.getItem('instructionShown')) {
                document.getElementById('instruction').classList.add('show');
                localStorage.setItem('instructionShown', 'light');
            }
        }
        
        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminLoginTime');
            stopAutoRefresh();
            location.reload();
        }
        
        function hideInstruction() {
            document.getElementById('instruction').classList.remove('show');
        }
        
        function startAutoRefresh() {
            ordersUpdateInterval = setInterval(() => {
                checkForNewOrders();
            }, 3000);
        }
        
        function stopAutoRefresh() {
            if (ordersUpdateInterval) {
                clearInterval(ordersUpdateInterval);
                ordersUpdateInterval = null;
            }
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }
        
        function checkForNewOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const lastUpdate = parseInt(localStorage.getItem('adminLastOrderUpdate') || '0');
            
            const newOrders = orders.filter(o => o.date > lastUpdate);
            if (newOrders.length > 0) {
                showNotification(`üì¶ ${newOrders.length} –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫!`, 'info');
                loadOrders();
                localStorage.setItem('adminLastOrderUpdate', Date.now().toString());
            }

            orders.forEach(order => {
                if (order.status === 'work' && order.chat) {
                    const chatKey = `adminLastChat_${order.id}`;
                    const lastChatUpdate = parseInt(localStorage.getItem(chatKey) || '0');
                    
                    const latestMessage = order.chat[order.chat.length - 1];
                    if (latestMessage && latestMessage.time > lastChatUpdate) {
                        if (latestMessage.from === 'client') {
                            showNotification(`üí¨ –ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç ${order.nick}`, 'info');
                            highlightOrderCard(order.id);
                        }
                        
                        if (currentOrderId === order.id) {
                            renderChatMessages(order);
                        }
                        
                        localStorage.setItem(chatKey, latestMessage.time.toString());
                    }
                }
            });
        }
        
        function highlightOrderCard(orderId) {
            const cards = document.querySelectorAll('.order-card');
            cards.forEach(card => {
                const title = card.querySelector('h4');
                if (title && title.textContent.includes(orderId.slice(-6))) {
                    card.classList.add('new-message');
                    setTimeout(() => card.classList.remove('new-message'), 3000);
                }
            });
        }
        
        function loadOrders(searchQuery = '') {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É
            let filtered = orders;
            if (searchQuery) {
                filtered = orders.filter(o => 
                    o.nick.toLowerCase().includes(searchQuery) ||
                    o.email.toLowerCase().includes(searchQuery) ||
                    o.id.toLowerCase().includes(searchQuery) ||
                    (o.idea && o.idea.toLowerCase().includes(searchQuery))
                );
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–∞–ø–æ–∫ –°–í–ï–†–•–£ –ø–æ–∏—Å–∫–∞
            if (currentFilter !== 'all') {
                filtered = filtered.filter(o => o.status === currentFilter);
            }
            
            updateCounts(orders);
            renderOrders(filtered);
            
            localStorage.setItem('adminLastOrderUpdate', Date.now().toString());
        }
        
        function updateCounts(orders) {
            document.getElementById('count-all').textContent = orders.length;
            document.getElementById('count-new').textContent = orders.filter(o => o.status === 'new').length;
            document.getElementById('count-work').textContent = orders.filter(o => o.status === 'work').length;
            document.getElementById('count-done').textContent = orders.filter(o => o.status === 'done').length;
            document.getElementById('count-reject').textContent = orders.filter(o => o.status === 'reject').length;
            document.getElementById('count-cancel').textContent = orders.filter(o => o.status === 'cancel_client').length;
        }
        
        function filterOrders(filter, element) {
            currentFilter = filter;
            document.querySelectorAll('.folder').forEach(f => f.classList.remove('active'));
            element.classList.add('active');
            loadOrders();
        }
        
        function getStatusText(status) {
            const texts = {
                'new': 'üìù –ù–æ–≤–∞—è',
                'work': 'üîß –í —Ä–∞–±–æ—Ç–µ',
                'done': '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                'cancel': '‚ùå –û—Ç–º–µ–Ω–µ–Ω–∞',
                'cancel_client': 'üë§ –û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞',
                'reject': '‚õî –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
            };
            return texts[status] || status;
        }
        
        function renderOrders(orders) {
            const grid = document.getElementById('ordersGrid');
            let filtered = currentFilter === 'all' ? orders : orders.filter(o => o.status === currentFilter);
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-folder">üì≠ –í —ç—Ç–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(order => `
                <div class="order-card" id="card_${order.id}">
                    <div class="order-header">
                        <h4>üì¶ #${order.id.slice(-6)}</h4>
                        <span>${getStatusText(order.status)}</span>
                    </div>
                    <div class="order-body">
                        <div class="order-info">
                            <p><label>üéÆ –ù–∏–∫</label><span>${order.nick}</span></p>
                            <p><label>üì± –¢–µ–ª–µ—Ñ–æ–Ω</label><span>${order.phone}</span></p>
                            <p class="full-width"><label>üìß –ü–æ—á—Ç–∞</label><span>${order.email}</span></p>
                            <p class="full-width"><label>üí° –ò–¥–µ—è</label><span>${order.idea}</span></p>
                            <p class="full-width"><label>‚ö° –ö–æ–º–∞–Ω–¥—ã</label><span>${order.commands || '–ù–µ—Ç'}</span></p>
                            ${order.rejectReason ? `<p class="full-width" style="color:#e74c3c"><label>‚ùå –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</label><span>${order.rejectReason}</span></p>` : ''}
                        </div>
                    </div>
                    <div class="order-actions">
                        ${order.status === 'new' ? `
                            <button class="btn btn-accept" onclick="acceptOrder('${order.id}')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="btn btn-reject" onclick="openRejectModal('${order.id}')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        ` : ''}
                        ${order.status === 'work' ? `
                            <button class="btn btn-chat" onclick="openChat('${order.id}')">üí¨ –ß–∞—Ç</button>
                            <button class="btn btn-done" onclick="completeOrder('${order.id}')">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                            <button class="btn btn-return" onclick="returnOrder('${order.id}')">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å</button>
                        ` : ''}
                        ${order.status === 'reject' ? `
                            <button class="btn btn-return" onclick="returnOrder('${order.id}')">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function acceptOrder(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                order.status = 'work';
                order.chat = order.chat || [];
                order.chat.push({
                    from: 'admin',
                    text: 'üëã –ü—Ä–∏–≤–µ—Ç! –Ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –ø—Ä–∏—Å—Ç—É–ø–∏–ª –∫ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ –≤–∞—à–µ–π –∑–∞—è–≤–∫–æ–π. –°–∫–æ—Ä–æ —Å–≤—è–∂—É—Å—å —Å –≤–∞–º–∏!',
                    time: Date.now()
                });
                localStorage.setItem('orders', JSON.stringify(orders));
                
                showNotification('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!', 'success');
                
                await notifyClientAccepted(order, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                
                loadOrders();
            }
        }
        
        function openRejectModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('rejectModal').classList.add('active');
            document.getElementById('rejectReason').value = '';
        }
        
        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('active');
            currentOrderId = null;
        }
        
        async function confirmReject() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                showNotification('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è!', 'error');
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === currentOrderId);
            
            if (order) {
                order.status = 'reject';
                order.rejectReason = reason;
                localStorage.setItem('orders', JSON.stringify(orders));
                
                showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!', 'success');
                
                await notifyOrderRejected(order, reason);
                
                closeRejectModal();
                loadOrders();
            }
        }
        
        async function completeOrder(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                order.status = 'done';
                localStorage.setItem('orders', JSON.stringify(orders));
                
                showNotification('–ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!', 'success');
                
                await notifyOrderDone(order);
                
                loadOrders();
            }
        }
        
        function returnOrder(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                order.status = 'new';
                localStorage.setItem('orders', JSON.stringify(orders));
                
                showNotification('–ó–∞—è–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞!', 'success');
                loadOrders();
            }
        }
        
        function openChat(orderId) {
            currentOrderId = orderId;
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            
            document.getElementById('chatTitle').textContent = `üí¨ ${order.nick}`;
            renderChatMessages(order);
            document.getElementById('chatModal').classList.add('active');
            
            startChatAutoRefresh(orderId);
        }
        
        function startChatAutoRefresh(orderId) {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
            }
            
            chatUpdateInterval = setInterval(() => {
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    renderChatMessages(order);
                }
            }, 2000);
        }
        
        function renderChatMessages(order) {
            const container = document.getElementById('chatMessages');
            const messages = order.chat || [];
            
            const isScrolledToBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
            
            container.innerHTML = messages.map(m => `
                <div class="message ${m.from}">
                    ${m.text}
                    <small>${new Date(m.time).toLocaleString('ru-RU')}</small>
                </div>
            `).join('');
            
            if (isScrolledToBottom) {
                container.scrollTop = container.scrollHeight;
            }
            
            const chatKey = `adminLastChat_${order.id}`;
            const latestMessage = messages[messages.length - 1];
            if (latestMessage) {
                localStorage.setItem(chatKey, latestMessage.time.toString());
            }
        }
        
        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentOrderId = null;
            
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }
        
        async function sendAdminMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === currentOrderId);
            
            if (order) {
                order.chat = order.chat || [];
                order.chat.push({ from: 'admin', text, time: Date.now() });
                localStorage.setItem('orders', JSON.stringify(orders));
                
                renderChatMessages(order);
                input.value = '';
                
                await notifyChatMessage(order, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', text);
            }
        }
        
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendAdminMessage();
        });
        
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        // --- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ---
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('adminTheme', isLight ? 'light' : 'dark');
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (localStorage.getItem('adminTheme') === 'light') {
            document.body.classList.add('light-theme');
        }
        
        // --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê ---
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            loadOrders(query);
        });
        
        // --- –õ–û–ì–ò–ö–ê –≠–ö–°–ü–û–†–¢–ê ---
        function exportData() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orders, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "orders_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification('üì¶ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
        }
        
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é loadOrders –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞
        // (—Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤—ã—à–µ)
        
        // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
    </script>
    <script> {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫', 'error');
    }


async function acceptOrder(orderId) {
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
        await updateOrderInFirebase(orderId, { 
            status: 'work',
            chat: [{
                from: 'admin',
                text: 'üëã –ü—Ä–∏–≤–µ—Ç! –Ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –ø—Ä–∏—Å—Ç—É–ø–∏–ª –∫ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ –≤–∞—à–µ–π –∑–∞—è–≤–∫–æ–π. –°–∫–æ—Ä–æ —Å–≤—è–∂—É—Å—å —Å –≤–∞–º–∏!',
                time: Date.now()
            }]
        });
        
        // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // ...
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏', 'error');
    }
}

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
</script>
</body>
</html>